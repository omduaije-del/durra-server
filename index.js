// index.js â€“ Durra Math Server (Ø¥ØµØ¯Ø§Ø± Ù…Ø·ÙˆÙ‘ÙŽØ±)

// 1) Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
const express = require("express");
const cors = require("cors");

// Ù†Ø³ØªØ®Ø¯Ù… node-fetch (Dynamic import) Ø­ØªÙ‰ ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ Render Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„
const fetch = (...args) =>
  import("node-fetch").then(({ default: fetch }) => fetch(...args));

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 10000;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

// âœ… Ù…Ø³Ø§Ø± ÙØ­Øµ Ø§Ù„ØµØ­Ø©
app.get("/health", (req, res) => {
  res.json({ ok: true, status: "healthy", service: "durra-server" });
});

// âœ… Ø¯Ø§Ù„Ø© ØµØºÙŠØ±Ø© ØªÙ†Ø¸Ù‘Ù Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
function cleanText(str) {
  if (!str) return "";
  return String(str)
    .replace(/\s+\n/g, "\n")
    .replace(/\n\s+/g, "\n")
    .trim();
}

// âœ… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
app.post("/ask", async (req, res) => {
  try {
    const question = cleanText(req.body?.question || "");

    if (!question) {
      return res.status(400).json({
        ok: false,
        error: "Ù„Ù… ÙŠØµÙ„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….",
      });
    }

    // 2) Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© OpenAI
    const apiRes = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: "gpt-4.1-mini",

        // ðŸ‘‡ Ù‡Ù†Ø§ Ø§Ù„Ø³Ø­Ø±: Ø¨Ø±Ù…Ø¬Ø© Ø´Ø®ØµÙŠØ© Ø¯ÙØ±Ù‘Ù‰
        messages: [
          {
            role: "system",
            content:
              [
                "Ø£Ù†Øª Ù…Ø¹Ù„Ù‘Ù…Ø© Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¹Ø±Ø¨ÙŠØ© Ø°ÙƒÙŠØ© Ø¬Ø¯Ù‹Ø§ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØŒ Ù…ØªÙˆØ³Ø·ØŒ Ø«Ø§Ù†ÙˆÙŠØŒ ÙˆØ¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¬Ø§Ù…Ø¹ÙŠØ© Ø¨Ø³ÙŠØ·Ø©).",
                "Ù…Ù‡Ù…Ù‘ØªÙƒ Ø£Ù†:",
                "1) ØªÙÙ‡Ù…ÙŠ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù…Ø³Ø£Ù„Ø© Ù„ÙØ¸ÙŠØ© Ø£Ùˆ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙˆØ±Ù…ÙˆØ².",
                "2) ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„ÙØ¸ÙŠØ©: Ø­ÙˆÙ‘Ù„ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ù„Ù‰ ØªØ¹Ø¨ÙŠØ±/Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆØ§Ø¶Ø­Ø©ØŒ Ø«Ù… Ø§Ø´Ø±Ø­ÙŠ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„ Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„.",
                "3) Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ø¨Ø³Ù‘Ø· ÙˆÙˆØ§Ø¶Ø­ØŒ Ù…Ø¹ Ø°ÙƒØ± Ø§Ù„Ø³Ø¨Ø¨ ÙÙŠ ÙƒÙ„ Ø®Ø·ÙˆØ© Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†.",
                "4) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ø­Ù„ØŒ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø°ÙƒØ±ÙŠ Ø·Ø±ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ø¶Ø­Ø© ÙÙ‚Ø·.",
                "5) Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†ØŒ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (0 1 2 3 4 5 6 7 8 9) Ø¹Ø§Ø¯ÙŠ.",
                "6) Ù„Ù„Ø£Ø³Ø³ Ø§ÙƒØªØ¨ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø´ÙƒÙ„ 5^3 ØŒ 7^2 (ÙˆØ³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ø±ØªÙØ¹ ÙÙˆÙ‚ Ø§Ù„Ø¹Ø¯Ø¯).",
                "7) Ù„Ù„ÙƒØ³ÙˆØ± Ø§ÙƒØªØ¨ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø´ÙƒÙ„ 3/4 ØŒ 1/5 ØŒ 7/10 (ÙˆØ³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¶Ù‡Ø§ ÙƒØ¨Ø³Ø· ÙˆÙ…Ù‚Ø§Ù… ÙÙˆÙ‚ Ø¨Ø¹Ø¶).",
                "8) Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ØºÙŠØ± Ø±ÙŠØ§Ø¶ÙŠ Ø£Ùˆ Ø¹Ø§Ù… (Ù…Ø«Ù„: Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø±Ø¨Ø¹ØŸ) ÙØ­Ø§ÙˆÙ„ÙŠ Ø£ÙˆÙ„Ø§Ù‹ ØªÙØ³ÙŠØ±Ù‡ ØªÙØ³ÙŠØ±Ù‹Ø§ Ø±ÙŠØ§Ø¶ÙŠÙ‹Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ø´ÙƒÙ„ Ù‡Ù†Ø¯Ø³ÙŠ Ù„Ù‡ Ø£Ø±Ø¨Ø¹ Ø£Ø¶Ù„Ø§Ø¹ Ù…ØªØ³Ø§ÙˆÙŠØ©).",
                "9) Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ø¶Ø­Ù‹Ø§ Ø£Ù†Ù‡ ØºÙŠØ± Ø±ÙŠØ§Ø¶ÙŠ ØªÙ…Ø§Ù…Ù‹Ø§ (Ø¯ÙŠÙ†ØŒ Ø·Ø¨ØŒ Ø·Ø¨Ø®ØŒ Ø£Ø®Ø¨Ø§Ø±...) Ø¹Ù†Ø¯Ù‡Ø§ ÙÙ‚Ø· Ù‚ÙˆÙ„ÙŠ Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø©: (Ø£Ù†Ø§ Ù…ØªØ®ØµÙ‘ØµØ© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙ‚Ø·ØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ ÙÙŠ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø±ÙŠØ§Ø¶ÙŠ).",
                "10) ØªØ¬Ù†Ù‘Ø¨ÙŠ Ø°ÙƒØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø¹Ù† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø£Ùˆ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…ÙˆØ² (Ù…Ø«Ù„: model, tokens, API, server, rate limit...). Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø£Ù† ÙŠØ¹Ø±Ù Ù‡Ø°Ù‡ Ø§Ù„ØªÙØ§ØµÙŠÙ„.",
                "11) Ø±ÙƒÙ‘Ø²ÙŠ Ø¹Ù„Ù‰ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø±ÙŠØ§Ø¶ÙŠØ©ØŒ ØµØ­ÙŠØ­Ø©ØŒ ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ø¹Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø©ØŒ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ø´Ø¬Ù‘Ø¹.",
              ].join(" "),
          },
          { role: "user", content: question },
        ],

        // Ù…Ø®Ø±Ø¬Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø´Ø±Ø­ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„
        max_tokens: 900,
        temperature: 0.2,
      }),
    });

    const data = await apiRes.json();

    // 3) Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ OpenAI (Ù…Ø«Ù„ Ø§Ù„Ø¶ØºØ· Ø£Ùˆ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)
    if (!apiRes.ok) {
      console.error("OpenAI error:", data);
      return res.status(500).json({
        ok: false,
        answer:
          "âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¢Ù† Ø¨Ø³Ø¨Ø¨ Ø¶ØºØ· Ø£Ùˆ Ø®Ù„Ù„ ØªÙ‚Ù†ÙŠ Ø¨Ø³ÙŠØ·. Ø¬Ø±Ù‘Ø¨ Ù†ÙØ³ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©ØŒ ÙˆØ¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„Ø®Ù„Ù„ Ø£Ø®Ø¨Ø± Ø§Ù„Ù…Ø¹Ù„Ù…Ø©.",
      });
    }

    const answerText = cleanText(
      data?.choices?.[0]?.message?.content || ""
    );

    if (!answerText) {
      return res.status(500).json({
        ok: false,
        answer:
          "âš ï¸ Ù„Ù… ØªØµÙ„Ù†ÙŠ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø¶Ø­Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©. Ø£Ø¹Ø¯ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ø¬Ø¯ÙŠØ¯.",
      });
    }

    // 4) Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
    res.json({
      ok: true,
      answer: answerText,
    });
  } catch (err) {
    console.error("Server error:", err);
    res.status(500).json({
      ok: false,
      answer:
        "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…. Ø£ØºÙ„Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø© ÙˆØ§ÙØªØ­ÙŠÙ‡Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø­Ø§ÙˆÙ„ÙŠ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.",
    });
  }
});

// 5) ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
app.listen(PORT, () => {
  console.log(`Durra math server running on port ${PORT}`);
});
